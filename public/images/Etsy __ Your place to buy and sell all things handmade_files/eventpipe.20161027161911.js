!function(e){window.Etsy=window.Etsy||{};var t=function(){};t.prototype={enabled:!1,firedEvents:[],init:function(t){var n=this;e&&e.Topic&&e.Topic("Eventpipe/event").subscribe(function(e){n.firedEvents.push(e)}),this.setDefaults(t.defaults),this.url=t.url,e.each(t.events||[],function(t,i){i.selector&&i.event?e(document).on(i.event,i.selector,function(){n.logEvent(i.attributes)}):i.attributes.primary_complement?(n.setPrimaryComplementDefaults(i.attributes),n.logEvent(i.attributes)):i.attributes.primary_perf?n.initPerfHandler(i):n.logEvent(i.attributes)})},initPerfHandler:function(e){var t=this;if(t.delayBeaconIsEnabled()){var n=!1,i=function(){n||(n=!0,t.processPerf(e.attributes),t.sendBeaconIsEnabled()&&navigator&&navigator.sendBeacon?t.logPerfEvent(e.attributes):t.logEvent(e.attributes))};window.addEventListener("load",function(){setTimeout(i,0)},!1),window.addEventListener("unload",i,!1)}},setDefaults:function(e){this.defaults=e,this.defaults.ref=document.referrer,this.defaults.loc=document.location.href,this.defaults.webkit_page_visibility=document.webkitVisibilityState,e.event_source||(this.defaults.event_source="web"),this.defaults.event_logger="frontend",this.defaults.isIosApp&&this.defaults.isIosApp===!0?this.defaults.event_source="ios":this.defaults.isAndroidApp&&this.defaults.isAndroidApp===!0&&(this.defaults.event_source="android")},getPageTime:function(){var e=document.getElementById("pageTime");return e?e.textContent||e.innerText:void 0},setPrimaryComplementDefaults:function(e){var t=this.getPageTime();t&&(e.page_time=t),window.document.documentElement&&(window.document.documentElement.clientWidth&&(e.viewport_width=window.document.documentElement.clientWidth),window.document.documentElement.clientHeight&&(e.viewport_height=window.document.documentElement.clientHeight)),window.screen&&(window.screen.height&&(e.screen_height=window.screen.height),window.screen.width&&(e.screen_width=window.screen.width)),window.devicePixelRatio&&(e.device_pixel_ratio=window.devicePixelRatio),window.orientation&&(e.orientation=window.orientation),"undefined"!=typeof window.performance&&window.chrome&&window.chrome.loadTimes&&window.chrome.loadTimes().firstPaintTime>0&&(window.Etsy.performance=window.Etsy.performance||{},window.Etsy.performance.firstAnimationFrameFired=Math.round(1e3*window.chrome.loadTimes().firstPaintTime))},processPerf:function(t){var n=this.getPageTime();if(n&&(t.page_time=n),window.performance&&window.performance.timing){var i=window.performance.timing;t.nav_start=i.navigationStart,t.fetch_start=i.fetchStart,t.dns_start=i.domainLookupStart,t.dns_end=i.domainLookupEnd,t.connect_start=i.connectStart,t.connect_end=i.connectEnd,t.secure_connect_start=i.secureConnectionStart,t.request_start=i.requestStart,t.response_start=i.responseStart,t.response_end=i.responseEnd,t.dom_completed=i.domComplete,t.dom_interactive=i.domInteractive,t.loaded_start=i.loadEventStart,t.loaded_end=i.loadEventEnd,t.dom_content_loaded_end=i.domContentLoadedEventEnd,t.has_sendbeacon=!(!navigator||!navigator.sendBeacon)}window.Etsy.performance&&window.Etsy.performance.firstAnimationFrameFired>0&&(t.start_render=window.Etsy.performance.firstAnimationFrameFired),window.Etsy.performance&&window.Etsy.performance.additional_log_data&&e.each(window.Etsy.performance.additional_log_data,function(e,n){t[e]=n})},logEvent:function n(e,t){var i=this;e.guid=e.guid||this.getGuid(),n.timer&&clearTimeout(n.timer),n.queue=n.queue||[],n.queue.push(e),n.timer=setTimeout(function(){var e={shared:i.defaults,events:n.queue};i.post(JSON.stringify(e),t),i.adminPublishEvent(e),n.queue=[]},50)},post:function(e,t){var n;if(window.XDomainRequest&&!this.sameOrigin())n=new window.XDomainRequest,n.onload=function(){"function"==typeof t&&t(n)},n.open("POST",this.url);else{if(window.XMLHttpRequest)n=new XMLHttpRequest;else{try{n=new ActiveXObject("MSXML2.XMLHTTP.6.0")}catch(i){}try{n||(n=new ActiveXObject("MSXML2.XMLHTTP"))}catch(i){}}n.onreadystatechange=function(){t&&"function"==typeof t&&4===n.readyState&&t(n)},n.open("POST",this.url,!0)}n.send(e)},logPerfEvent:function(e){var t=this;e.guid=e.guid||this.getGuid();var n={shared:t.defaults,events:[e]};t.postPerf(n),t.adminPublishEvent(n)},postPerf:function(e){if(navigator&&navigator.sendBeacon){for(var t=0;t<e.events.length;t++)e.events[t].attempted_send_beacon=!0;if(navigator.sendBeacon(this.url,JSON.stringify(e)))return;for(var t=0;t<e.events.length;t++)e.events[t].send_beacon_failed=!0}this.post(JSON.stringify(e))},sameOrigin:function(){var e=document.createElement("a");return e.href=this.url,e.href.hostname==window.location.hostname},logFromOld:function(t,n){var i=e.extend({},t);e.each(i,function(e,t){0===e.indexOf(".")&&(i[e.slice(1)]=t,delete i[e])}),i.event_name=i.php_event_name,delete i.php_event_name,delete i.php_ab_var_names,delete i.php_ab_selector_names,delete i.php_ab_test_names,this.logEvent(i,n)},padZeros:function(e,t){var n=t-e.length;return n>0?new Array(n+1).join("0")+e:e},adminPublishEvent:function(t){e&&e.Topic&&e.Topic("Eventpipe/event").publish(t)},delayBeaconIsEnabled:function(){return Etsy.Context&&Etsy.Context.featureIsEnabled&&Etsy.Context.featureIsEnabled("perf_send_perf_beacon")},sendBeaconIsEnabled:function(){return Etsy.Context&&Etsy.Context.featureIsEnabled&&Etsy.Context.featureIsEnabled("perf_navigator_sendbeacon")},getGuid:function(){var e=0;return function(){var t=this.defaults.page_guid||"",n=(e++).toString(16);return t.substr(0,t.length-2)+this.padZeros(n,2)}}()},window.EventPipe||(window.EventPipe=new t)}(jQuery),"function"==typeof define&&define.amd&&define("etsy/eventpipe",[],function(){return window.EventPipe});